# Simple backup role. Creates a snapshot archive of specified directories and
# rotates old backups based on retention days.

- name: "Create backup base directory"
  ansible.builtin.file:
    path: "{{ backup_base_dir }}"
    state: directory
    mode: '0755'

- name: "Create snapshot directory"
  ansible.builtin.file:
    path: "{{ backup_base_dir }}/snapshots"
    state: directory
    mode: '0755'

- name: "Find old snapshot archives"
  ansible.builtin.find:
    paths: "{{ backup_base_dir }}/snapshots"
    patterns: 'snapshot-*.tar.gz'
    age: "{{ backup_retention_days }}d"
    age_stamp: ctime
  register: old_snapshots

- name: "Remove outdated snapshots"
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_snapshots.files }}"
  when: old_snapshots.matched > 0

- name: "Create new backup snapshot"
  ansible.builtin.archive:
    path: "{{ backup_paths }}"
    dest: "{{ backup_base_dir }}/snapshots/snapshot-{{ ansible_date_time.iso8601 }}.tar.gz"
    format: gz
  when: backup_enabled | default(true)