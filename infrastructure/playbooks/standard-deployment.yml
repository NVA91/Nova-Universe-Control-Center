---
- name: Standard Deployment - Production Setup
  hosts: all
  gather_facts: yes
  
  vars:
    deployment_profile: "{{ DEPLOYMENT_PROFILE | default('standard') }}"
    apps_to_install: "{{ APPS | default('all-core') }}"
    enable_monitoring: "{{ MONITORING | default('enabled') }}"
    enable_backups: "{{ BACKUPS | default('enabled') }}"
  
  tasks:
    - name: "ğŸš€ Deployment Banner"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸš€ STANDARD DEPLOYMENT GESTARTET"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Profil: {{ deployment_profile }}"
          - "Apps: {{ apps_to_install }}"
          - "Monitoring: {{ enable_monitoring }}"
          - "Backups: {{ enable_backups }}"
          - "Host: {{ ansible_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: "ğŸ“Š System Information"
      debug:
        msg:
          - "OS Family: {{ ansible_os_family }}"
          - "Python: {{ ansible_python_version }}"
          - "CPU Cores: {{ ansible_processor_vcpus }}"
          - "Memory: {{ (ansible_memtotal_mb / 1024) | round(1) }} GB"
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NUR AUF DEBIAN/UBUNTU AUSFÃœHREN
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ“¦ Update APT Cache (Debian/Ubuntu only)"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      become: yes
      ignore_errors: yes
    
    - name: "ğŸ“¦ Install Core Packages (Debian/Ubuntu only)"
      apt:
        name:
          - curl
          - wget
          - git
          - python3
          - python3-pip
        state: present
      when: 
        - ansible_os_family == "Debian"
        - apps_to_install == "all-core"
      become: yes
      ignore_errors: yes
    
    - name: "ğŸ³ Check if Docker is installed"
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false
    
    - name: "ğŸ³ Install Docker (Debian/Ubuntu only)"
      shell: |
        curl -fsSL https://get.docker.com | sh
        systemctl enable docker
        systemctl start docker
      when: 
        - ansible_os_family == "Debian"
        - docker_check.rc != 0
      become: yes
      ignore_errors: yes
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # FUNKTIONIERT ÃœBERALL (auch Alpine/Container)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ“ Create Test Directories"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/nova-deployment
        - /tmp/nova-deployment/logs
      # Kein become nÃ¶tig fÃ¼r /tmp
    
    - name: "ğŸ“ Create Deployment Log"
      copy:
        content: |
          Deployment Profile: {{ deployment_profile }}
          Apps: {{ apps_to_install }}
          Monitoring: {{ enable_monitoring }}
          Backups: {{ enable_backups }}
          Host: {{ ansible_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Timestamp: {{ ansible_date_time.iso8601 }}
        dest: /tmp/nova-deployment/deployment.log
        mode: '0644'
    
    - name: "ğŸ‰ Deployment Summary"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘      âœ… DEPLOYMENT ERFOLGREICH!      â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ Profil: {{ deployment_profile }}     â•‘"
          - "â•‘ Host: {{ ansible_hostname }}         â•‘"
          - "â•‘ OS: {{ ansible_os_family }}          â•‘"
          - "â•‘                                       â•‘"
          - "â•‘ Log: /tmp/nova-deployment/           â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
