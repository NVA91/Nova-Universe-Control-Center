---
# Standard Deployment Playbook
#
# Dieses Playbook fÃ¼hrt eine Standardâ€‘Produktionseinrichtung durch und ruft
# anschliessend die rollenbasierten Optimierungen (CPUâ€‘Tuning, Storageâ€‘Setup,
# Systemâ€‘Updates, Netzwerkâ€‘Hardening, Backups) auf. Vor den Rollen werden
# generische Vorbereitungsschritte ausgefÃ¼hrt, die auf allen Hosts laufen.

- name: Standard Deployment - Production Setup
  hosts: all
  gather_facts: yes

  vars:
    # Deploymentâ€‘Parameter kÃ¶nnen Ã¼ber Umgebungsvariablen Ã¼berschrieben werden
    deployment_profile: "{{ DEPLOYMENT_PROFILE | default('standard') }}"
    apps_to_install: "{{ APPS | default('all-core') }}"
    enable_monitoring: "{{ MONITORING | default('enabled') }}"
    enable_backups: "{{ BACKUPS | default('enabled') }}"

  pre_tasks:
    # Anzeige eines Banners mit Informationen zum Deployment
    - name: "ğŸš€ Deployment Banner"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸš€ STANDARD DEPLOYMENT GESTARTET"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Profil: {{ deployment_profile }}"
          - "Apps: {{ apps_to_install }}"
          - "Monitoring: {{ enable_monitoring }}"
          - "Backups: {{ enable_backups }}"
          - "Host: {{ ansible_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: "ğŸ“Š System Information"
      debug:
        msg:
          - "OS Family: {{ ansible_os_family }}"
          - "Python: {{ ansible_python_version }}"
          - "CPU Cores: {{ ansible_processor_vcpus }}"
          - "Memory: {{ (ansible_memtotal_mb / 1024) | round(1) }} GB"

    # Debian/Ubuntuâ€‘spezifische Vorbereitungen
    - name: "ğŸ“¦ Update APT Cache (Debian/Ubuntu only)"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      become: yes
      ignore_errors: yes

    - name: "ğŸ“¦ Install Core Packages (Debian/Ubuntu only)"
      apt:
        name:
          - curl
          - wget
          - git
          - python3
          - python3-pip
        state: present
      when:
        - ansible_os_family == "Debian"
        - apps_to_install == "all-core"
      become: yes
      ignore_errors: yes

    # Docker prÃ¼fen/installieren
    - name: "ğŸ³ Check if Docker is installed"
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: "ğŸ³ Install Docker (Debian/Ubuntu only)"
      shell: |
        curl -fsSL https://get.docker.com | sh
        systemctl enable docker
        systemctl start docker
      when:
        - ansible_os_family == "Debian"
        - docker_check.rc != 0
      become: yes
      ignore_errors: yes

  roles:
    # Hardwareâ€‘ und Systemâ€‘Optimierungen
    - role: system_tuning
      tags: tuning
    - role: storage_setup
      tags: storage
    - role: system_update
      tags: update
    - role: network_setup
      tags: network
    - role: backup
      tags: backup

  post_tasks:
    # Generische Dateierstellung â€“ funktioniert auf allen Systemen
    - name: "ğŸ“ Create Test Directories"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/nova-deployment
        - /tmp/nova-deployment/logs
      # Kein become nÃ¶tig fÃ¼r /tmp

    - name: "ğŸ“ Create Deployment Log"
      copy:
        content: |
          Deployment Profile: {{ deployment_profile }}
          Apps: {{ apps_to_install }}
          Monitoring: {{ enable_monitoring }}
          Backups: {{ enable_backups }}
          Host: {{ ansible_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Timestamp: {{ ansible_date_time.iso8601 }}
        dest: /tmp/nova-deployment/deployment.log
        mode: '0644'
   
    - name: "ğŸ‰ Deployment Summary"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘      âœ… DEPLOYMENT ERFOLGREICH!      â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ Profil: {{ deployment_profile }}     â•‘"
          - "â•‘ Host: {{ ansible_hostname }}         â•‘"
          - "â•‘ OS: {{ ansible_os_family }}          â•‘"
          - "â•‘                                       â•‘"
          - "â•‘ Log: /tmp/nova-deployment/           â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  handlers:
    # Handler fÃ¼r system_tuning Rolle
    - name: "ğŸ”„ Restart System Tuning Services"
      service:
        name: "{{ item }}"
        state: restarted
      with_items:
        - apache2
        - mysql
        - php7.4-fpm
      when: ansible_os_family == "Debian"
      become: yes
      ignore_errors: yes

    # Handler fÃ¼r storage_setup Rolle
    - name: "ğŸ”„ Remount Filesystems"
      command: mount -o remount,{{ item.options }} {{ item.device }} {{ item.mount }}
      with_items: "{{ ansible_mounts }}"
      when: item.mount is defined and item.mount != '' and item.fstype != 'tmpfs'
      become: yes
      ignore_errors: yes

    # Handler fÃ¼r system_update Rolle
    - name: "ğŸ”„ Reboot if required by system update"
      reboot:
        msg: "Rebooting the system after updates"
        pre_reboot_delay: 0
        post_reboot_delay: 300
      when: ansible_os_family == "Debian" and ansible_pkg_mgr == "apt"
      become: yes
      ignore_errors: yes

    # Handler fÃ¼r network_setup Rolle
    - name: "ğŸ”„ Restart Networking"
      service:
        name: networking
        state: restarted
      when: ansible_os_family == "Debian"
      become: yes
      ignore_errors: yes

    # Handler fÃ¼r backup Rolle
    - name: "ğŸ”„ Restart Backup Services"
      service:
        name: "{{ item }}"
        state: restarted
      with_items:
        - rsyslog
        - cron
      when: ansible_os_family == "Debian"
      become: yes
      ignore_errors: yes